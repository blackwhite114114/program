<!DOCTYPE html>
<html lang="zh">
<head> 
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>物联网设备监控</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- MQTT.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/4.3.7/mqtt.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .card {
            margin-bottom: 20px;
        }
        #dataLog {
            height: 200px;
            overflow-y: auto;
        }
        .chart-container {
            height: 400px;  /* 固定图表容器高度 */
            position: relative;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h2 class="text-center mb-4">物联网设备监控面板</h2>
        
        <!-- MQTT连接配置 -->
        <div class="card">
            <div class="card-header">
                MQTT连接配置
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <input type="text" id="host" class="form-control" value="localhost" placeholder="MQTT Broker Host">
                    </div>
                    <div class="col-md-2">
                        <input type="number" id="port" class="form-control" value="9001" placeholder="Port">
                    </div>
                    <div class="col-md-3">
                        <button id="connectBtn" class="btn btn-primary">连接</button>
                        <button id="disconnectBtn" class="btn btn-danger" disabled>断开</button>
                    </div>
                    <div class="col-md-4">
                        <span id="connectionStatus" class="badge bg-secondary">未连接</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 订阅配置 -->
        <div class="card">
            <div class="card-header">
                主题订阅
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <input type="text" id="subTopic" class="form-control" value="devices/+/+/data" placeholder="订阅主题">
                    </div>
                    <div class="col-md-4">
                        <button id="subscribeBtn" class="btn btn-success" disabled>订阅</button>
                        <button id="unsubscribeBtn" class="btn btn-warning" disabled>取消订阅</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 发布消息 -->
        <div class="card">
            <div class="card-header">
                发布消息
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <input type="text" id="pubTopic" class="form-control" placeholder="发布主题">
                    </div>
                    <div class="col-md-6">
                        <input type="text" id="pubMessage" class="form-control" placeholder="消息内容">
                    </div>
                    <div class="col-md-2">
                        <button id="publishBtn" class="btn btn-primary" disabled>发布</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 数据显示 -->
        <div class="row">
            <!-- 实时数据图表 -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        实时数据图表
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="dataChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 数据日志 -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        数据日志
                    </div>
                    <div class="card-body">
                        <div id="dataLog" class="border p-2"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let client = null;
        let chart = null;

        // 初始化图表
        function initChart() {
            const ctx = document.getElementById('dataChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: '温度',
                        data: [],
                        borderColor: 'rgb(255, 99, 132)',
                        tension: 0.1
                    }, {
                        label: '湿度',
                        data: [],
                        borderColor: 'rgb(54, 162, 235)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,  // 允许调整高度
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0,0,0,0.1)'  // 网格线颜色
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0,0,0,0.1)'  // 网格线颜色
                            }
                        }
                    },
                    animations: {
                        duration: 500  // 动画效果
                    },
                    plugins: {
                        legend: {
                            position: 'top'  // 图例位置
                        }
                    }
                }
            });
        }

        // 更新图表数据
        function updateChart(data) {
            if (!chart) return;
            
            const timestamp = new Date().toLocaleTimeString();
            
            // 添加新数据点
            chart.data.labels.push(timestamp);
            chart.data.datasets[0].data.push(data.temperature);
            chart.data.datasets[1].data.push(data.humidity);

            // 保持最近20个数据点
            if (chart.data.labels.length > 20) {
                chart.data.labels.shift();
                chart.data.datasets.forEach(dataset => dataset.data.shift());
            }

            chart.update();
        }

        // 添加日志
        function addLog(message) {
            const logDiv = document.getElementById('dataLog');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `<div><small>${timestamp}</small> ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // MQTT连接
        document.getElementById('connectBtn').addEventListener('click', () => {
            const host = document.getElementById('host').value;
            const port = document.getElementById('port').value;
            const url = `ws://${host}:${port}/mqtt`;

            try {
                client = mqtt.connect(url);
                
                client.on('connect', () => {
                    document.getElementById('connectionStatus').className = 'badge bg-success';
                    document.getElementById('connectionStatus').textContent = '已连接';
                    document.getElementById('connectBtn').disabled = true;
                    document.getElementById('disconnectBtn').disabled = false;
                    document.getElementById('subscribeBtn').disabled = false;
                    document.getElementById('publishBtn').disabled = false;
                    addLog('MQTT已连接');
                });

                client.on('message', (topic, message) => {
                    try {
                        const data = JSON.parse(message.toString());
                        addLog(`收到数据: ${topic} - ${message.toString()}`);
                        if (data.data && data.data.temperature !== undefined && data.data.humidity !== undefined) {
                            updateChart(data.data);  // 传入data字段的内容
                        }
                    } catch (e) {
                        addLog(`消息解析错误: ${e.message}`);
                    }
                });

                client.on('error', (error) => {
                    addLog(`MQTT错误: ${error.message}`);
                });

            } catch (e) {
                addLog(`连接错误: ${e.message}`);
            }
        });

        // 断开连接
        document.getElementById('disconnectBtn').addEventListener('click', () => {
            if (client) {
                client.end();
                document.getElementById('connectionStatus').className = 'badge bg-secondary';
                document.getElementById('connectionStatus').textContent = '未连接';
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('disconnectBtn').disabled = true;
                document.getElementById('subscribeBtn').disabled = true;
                document.getElementById('unsubscribeBtn').disabled = true;
                document.getElementById('publishBtn').disabled = true;
                addLog('MQTT已断开连接');
            }
        });

        // 订阅主题
        document.getElementById('subscribeBtn').addEventListener('click', () => {
            const topic = document.getElementById('subTopic').value;
            if (client && topic) {
                client.subscribe(topic, (err) => {
                    if (!err) {
                        addLog(`已订阅主题: ${topic}`);
                        document.getElementById('unsubscribeBtn').disabled = false;
                    }
                });
            }
        });

        // 取消订阅
        document.getElementById('unsubscribeBtn').addEventListener('click', () => {
            const topic = document.getElementById('subTopic').value;
            if (client && topic) {
                client.unsubscribe(topic, (err) => {
                    if (!err) {
                        addLog(`已取消订阅: ${topic}`);
                        document.getElementById('unsubscribeBtn').disabled = true;
                    }
                });
            }
        });

        // 发布消息
        document.getElementById('publishBtn').addEventListener('click', () => {
            const topic = document.getElementById('pubTopic').value;
            const message = document.getElementById('pubMessage').value;
            if (client && topic && message) {
                client.publish(topic, message);
                addLog(`已发布消息: ${topic} - ${message}`);
            }
        });

        // 初始化图表
        initChart();
    </script>
</body>
</html>
